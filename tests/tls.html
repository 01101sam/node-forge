<html>
   <head>
      <link type="text/css" rel="stylesheet" media="all" href="screen.css" />
      <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
      <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
      <script type="text/javascript" src="forge/debug.js"></script>
      <script type="text/javascript" src="forge/util.js"></script>
      <script type="text/javascript" src="forge/log.js"></script>
      <script type="text/javascript" src="forge/socket.js"></script>
      <script type="text/javascript" src="forge/md5.js"></script>
      <script type="text/javascript" src="forge/sha1.js"></script>
      <script type="text/javascript" src="forge/hmac.js"></script>
      <script type="text/javascript" src="forge/aes.js"></script>
      <script type="text/javascript" src="forge/asn1.js"></script>
      <script type="text/javascript" src="forge/jsbn.js"></script>
      <script type="text/javascript" src="forge/jsbn2.js"></script>
      <script type="text/javascript" src="forge/prng.js"></script>
      <script type="text/javascript" src="forge/random.js"></script>
      <script type="text/javascript" src="forge/pki.js"></script>
      <script type="text/javascript" src="forge/tls.js"></script>
      <script type="text/javascript" src="forge/http.js"></script>
      
      <script type="text/javascript">
      swfobject.embedSWF(
         'forge/SocketPool.swf', 'socketPool', '400', '224', '9.0.0',
         false, {}, {allowscriptaccess: 'always'}, {});
      
      // CA certificate for test server
      var certificatePem =
         '-----BEGIN CERTIFICATE-----' +
         'MIIEaDCCA1CgAwIBAgIJAJuj0AjEWncuMA0GCSqGSIb3DQEBBQUAMH8xCzAJBgNV' +
         'BAYTAlVTMREwDwYDVQQIEwhWaXJnaW5pYTETMBEGA1UEBxMKQmxhY2tzYnVyZzEd' +
         'MBsGA1UEChMURGlnaXRhbCBCYXphYXIsIEluYy4xGjAYBgNVBAsTEUZvcmdlIFRl' +
         'c3QgU2VydmVyMQ0wCwYDVQQDEwR0ZXN0MB4XDTEwMDcxMzE3MjAzN1oXDTMwMDcw' +
         'ODE3MjAzN1owfzELMAkGA1UEBhMCVVMxETAPBgNVBAgTCFZpcmdpbmlhMRMwEQYD' +
         'VQQHEwpCbGFja3NidXJnMR0wGwYDVQQKExREaWdpdGFsIEJhemFhciwgSW5jLjEa' +
         'MBgGA1UECxMRRm9yZ2UgVGVzdCBTZXJ2ZXIxDTALBgNVBAMTBHRlc3QwggEiMA0G' +
         'CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCm/FobjqK8CVP/Xbnpyhf1tpoyaiFf' +
         'ShUOmlWqL5rLe0Q0dDR/Zur+sLMUv/1T4wOfFkjjxvZ0Sk5NIjK3Wy2UA41a+M3J' +
         'RTbCFrg4ujsovFaD4CDmV7Rek0qJB3m5Gp7hgu5vfL/v+WrwxnQObNq+IrTMSA15' +
         'cO4LzNIPj9K1LN2dB+ucT7xTQFHAfvLLgLlCLiberoabF4rEhgTMTbmMtFVKSt+P' +
         'xgQIYPnhw1WuAvE9hFesRQFdfARLqIZk92FeHkgtHv9BAunktJemcidbowTCTBaM' +
         '/njcgi1Tei/LFkph/FCVyGER0pekJNHX626bAQSLo/srsWfmcll9rK6bAgMBAAGj' +
         'geYwgeMwHQYDVR0OBBYEFCau5k6jxezjULlLuo/liswJlBF8MIGzBgNVHSMEgasw' +
         'gaiAFCau5k6jxezjULlLuo/liswJlBF8oYGEpIGBMH8xCzAJBgNVBAYTAlVTMREw' +
         'DwYDVQQIEwhWaXJnaW5pYTETMBEGA1UEBxMKQmxhY2tzYnVyZzEdMBsGA1UEChMU' +
         'RGlnaXRhbCBCYXphYXIsIEluYy4xGjAYBgNVBAsTEUZvcmdlIFRlc3QgU2VydmVy' +
         'MQ0wCwYDVQQDEwR0ZXN0ggkAm6PQCMRady4wDAYDVR0TBAUwAwEB/zANBgkqhkiG' +
         '9w0BAQUFAAOCAQEAnP/2mzFWaoGx6+KAfY8pcgnF48IoyKPx5cAQyzpMo+uRwrln' +
         'INcDGwNx6p6rkjFbK27TME9ReCk+xQuVGaKOtqErKECXWDtD+0M35noyaOwWIFu2' +
         '7gPZ0uGJ1n9ZMe/S9yZmmusaIrc66rX4o+fslUlH0g3SrH7yf83M8aOC2pEyCsG0' +
         'mNNfwSFWfmu+1GMRHXJQ/qT8qBX8ZPhzRY2BAS6vr+eh3gwXR6yXLA8Xm1+e+iDU' +
         'gGTQoYkixDIL2nhvd4AFFlE977BiE+0sMS1eJKUUbQ36MLAWb5oOZKHrphEvqMKA' +
         'eGDO3qoDqB5TkZC3x38DXBDvAZ01d9s0fvveag==' +
         '-----END CERTIFICATE-----';
      
      // local aliases
      var net = window.forge.net;
      var http = window.forge.http;
      var util = window.forge.util;

      var client;
      
      function client_init(primed)
      {
         try
         {
	         var sp = net.createSocketPool({
	            flashId: 'socketPool',
	            policyPort: 19945,
	            msie: false
	         });
	         client = http.createClient({
	            //url: 'https://localhost:4433',
	            url: 'https://' + window.location.host,
	            socketPool: sp,
	            connections: 10,
	            caCerts: [certificatePem],
	            verify: function(c, verified, depth, certs)
	            {
	               console.log(
	   	            'TLS certificate ' + depth + ' verified', verified);
	               // Note: change to always true to test verifying without cert
	               //return verified;
	               // FIXME: temporarily accept any cert to allow hitting any bpe
	               if(verified !== true)
	               {
	                  console.log('Certificate NOT verified. Ignored for test.');
	               }
	               return true;
	            },
	            primeTlsSockets: primed
	         });
	         document.getElementById('feedback').innerHTML =
		         'http client created';
         }
         catch(ex)
         {
            console.log(ex);
         }
         
         return false;
      }
      
      function client_cleanup()
      {
         var sp = client.socketPool;
         client.destroy();
         sp.destroy();
         document.getElementById('feedback').innerHTML =
            'http client cleaned up';
         return false;
      }

      function client_send()
      {
         /*
         var request = http.createRequest({
            method: 'POST',
            path: '/',
            body: 'echo=foo',
            headers: [{'Content-Type': 'application/x-www-form-urlencoded'}]
         });
         */
         var request = http.createRequest({
            method: 'GET',
            path: '/'
         });
         
         client.send({
            request: request,
            connected: function(e)
            {
               console.log('connected', e);
            },
            headerReady: function(e)
            {
               console.log('header ready', e);
            },
            bodyReady: function(e)
            {
               console.log('body ready', e);

               // FIXME: current test server doesn't seem to handle keep-alive
               // correctly, so close connection 
               e.socket.close();
            },
            error: function(e)
            {
               console.log('error', e);
            }
         });
         document.getElementById('feedback').innerHTML =
            'http request sent';
         return false;
      }

      function client_send_10()
      {
         for(var i = 0; i < 10; ++i)
         {
            client_send();
         }
         return false;
      }

      function client_cookies()
      {
         var cookie =
         {
            name: 'test-cookie',
            value: 'test-value',
            maxAge: -1,
            secure: true,
            path: '/'
         };
         client.setCookie(cookie);
         console.log('cookie', client.getCookie('test-cookie'));
      }

      function client_clear_cookies()
      {
         client.clearCookies();
      }
      
      </script>
   </head>
   <body>
      <div class="nav"><a href="index.html">Forge Tests</a> / TLS</div>
      <div class="content">

      <div id="socketPool">
         <p>Could not load the flash SocketPool.</p>
      </div>
      <p>Use the controls below to test the http client.</p>
      <div id="controls">
         <button id="init" onclick="javascript:return client_init(false);">init</button>
         <button id="init_primed" onclick="javascript:return client_init(true);">init primed</button>
         <button id="cleanup" onclick="javascript:return client_cleanup();">cleanup</button>
         <button id="send" onclick="javascript:return client_send();">send</button>
         <button id="send10" onclick="javascript:return client_send_10();">send 10</button>
         <button id="client_cookies" onclick="javascript:return client_cookies();">cookies</button>
         <button id="clear_cookies" onclick="javascript:return client_clear_cookies();">clear cookies</button>
      </div>
      <p>Feedback from the flash SocketPool:</p>
      <div id="feedback">
      None
      </div>

      </div>
   </body>
</html>
